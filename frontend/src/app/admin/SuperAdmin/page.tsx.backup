
"use client";

import React, { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
// Toast functionality will be handled with native alerts for now
import AgriCopilotTable from '../components/AgriCopilotTable';
import UserDetailsModal from '../components/UserDetailsModal';
import * as XLSX from 'xlsx';
import ProtectedRoute from '@/app/admin/components/ProtectedRoute';
import Topbar from '@/app/admin/components/Topbar';
import { 
  Activity,
  Bell,
  Calendar,
  ChevronDown, 
  ChevronRight,
  Clock,
  Download,
  FileText,
  Home, 
  Info,
  List,
  Lock, 
  LogOut, 
  Mail,
  MapPin,
  Menu,
  MoreHorizontal,
  Phone,
  Plus,
  Search,
  Settings,
  ShoppingCart,
  Sprout,
  Star,
  Store,
  Upload,
  User,
  UserCheck,
  UserPlus,
  Users,
  X
} from 'lucide-react';

type UserType = 'agricopilot' | 'farmer' | 'landowner' | 'vendor' | 'buyer' | 'consumer';
type TabType = 'dashboard' | 'onboard' | 'activities' | 'addEmployee';

interface AgriCopilot {
  id: string;
  custom_id: string;
  full_name: string;
  email: string;
  phone: string;
  aadhar_number: string;
  is_verified: boolean;
  verification_status: string;
  created_at: string;
  photo_url?: string;
  aadhar_front_url?: string;
  aadhar_back_url?: string;
}

interface SuperAdminProps {
  onLogout?: () => void;
}

const API_BASE_URL = process.env.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:8000';

// Backend-accepted member types
const BACKEND_MEMBER_TYPES = ['farmer', 'landowner', 'vendor', 'buyer', 'agri_copilot'];

// Normalize a raw member type string to backend-accepted values.
const normalizeMemberType = (raw?: string | null): string | null => {
  if (!raw) return null;
  let s = String(raw).toLowerCase().trim();
  // common variants
  s = s.replace(/[-\s]/g, '_'); // spaces or dashes -> underscore
  s = s.replace(/__+/g, '_');
  // map UI/CSV "agricopilot" variants to backend "agri_copilot"
  if (s === 'agricopilot' || s === 'agri_copilot' || s === 'agri-copilot' || s === 'agri_copilots' || s === 'agricopilots' || s === 'copilot' || s === 'agri_copilot') {
    return 'agri_copilot';
  }
  // simple passthrough for exact backend types
  if (BACKEND_MEMBER_TYPES.includes(s)) return s;
  // allow plural forms
  if (s.endsWith('s')) {
    const singular = s.slice(0, -1);
    if (BACKEND_MEMBER_TYPES.includes(singular)) return singular;
  }

  return null; // unknown
}

const SuperAdmin: React.FC<SuperAdminProps> = ({ onLogout }) => {
  const [activeTab, setActiveTab] = useState<TabType>('dashboard');

  const handleUpdateStatus = async (userId: string, status: 'approve' | 'reject', userType: UserType) => {
    try {
      setLoading(true);
      
      // Debug: Check token before making request - try multiple possible keys
      let token = localStorage.getItem('access_token');
      
      // Fallback: Try other possible token keys
      if (!token) {
        token = localStorage.getItem('token');
      }
      if (!token) {
        token = localStorage.getItem('authToken');
      }
      
      console.log('üîç DEBUG: Token check before API call:', {
        tokenExists: !!token,
        tokenLength: token?.length || 0,
        tokenPreview: token ? `${token.substring(0, 20)}...` : 'null',
        allKeys: Object.keys(localStorage)
      });
      
      if (!token) {
        console.error('‚ùå No token found in localStorage');
        console.error('üìã All localStorage keys:', Object.keys(localStorage));
        console.error('üìã localStorage contents:', {
          access_token: localStorage.getItem('access_token'),
          token: localStorage.getItem('token'),
          authToken: localStorage.getItem('authToken'),
          user: localStorage.getItem('user'),
          userRole: localStorage.getItem('userRole')
        });
        alert('You are not logged in. Please login from the Authentication page.');
        setLoading(false);
        return;
      }
      
      let endpoint;
      if (userType === 'agricopilot') {
        endpoint = status === 'approve' 
          ? `${API_BASE_URL}/admin/approve-agri-copilot/${userId}`
          : `${API_BASE_URL}/admin/verify/agri-copilot/${userId}`;
      } else {
        // All verification endpoints are under /admin/verify/
        endpoint = `${API_BASE_URL}/admin/verify/${userType}/${userId}`;
      }
      
      console.log('üöÄ Making API request to:', endpoint);
      
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          status: status === 'approve' ? 'approved' : 'rejected'
        })
      });

      console.log('üìã Verification response:', response.status, response.statusText);
      
      if (!response.ok) {
        const errorData = await response.text();
        console.error('‚ùå Verification error:', errorData);
        
        // Check if it's a token expiration error
        if (response.status === 401 || response.status === 403 || errorData.includes('expired') || errorData.includes('Signature has expired')) {
          alert('Your session has expired. Please login again.');
          localStorage.removeItem('access_token');
          localStorage.removeItem('user_type');
          localStorage.removeItem('user_email');
          // Redirect to login page
          window.location.href = '/';
          return;
        }
        
        throw new Error(`Failed to update status: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();
      console.log('‚úÖ Verification success:', result);
      
      // Close the appropriate modal based on user type
      if (userType === 'agricopilot') {
        setShowCopilotDetails(false);
        setSelectedCopilot(null);
      } else {
        // Close user details modal for all other user types
        setShowUserDetails(false);
        setSelectedDetailUser(null);
      }

      // Get user type display name
      const userTypeDisplay = userType.charAt(0).toUpperCase() + userType.slice(1);

      // Show success message
      alert(`‚úÖ ${userTypeDisplay} has been ${status === 'approve' ? 'approved' : 'rejected'} successfully!`);

      // Refresh the relevant user list
      switch (userType) {
        case 'farmer':
          await fetchFarmers();
          break;
        case 'landowner':
          await fetchLandowners();
          break;
        case 'vendor':
          await fetchVendors();
          break;
        case 'buyer':
          await fetchBuyers();
          break;
        case 'agricopilot':
          await fetchCopilots();
          break;
      }

      // Also refresh the counts
      await fetchCounts();
      
    } catch (err) {
      console.error('Error updating status:', err);
      
      // Check if it's a network/CORS error
      if (err instanceof TypeError && err.message.includes('Failed to fetch')) {
        alert(`Network error: Unable to connect to the server. This might be due to:\n1. Server is not running\n2. CORS configuration issue\n3. Your session has expired\n\nPlease try logging in again.`);
        localStorage.removeItem('access_token');
        localStorage.removeItem('user_type');
        localStorage.removeItem('user_email');
      } else {
        alert(`Failed to ${status} ${userType}. ${err instanceof Error ? err.message : 'Please try again.'}`);
      }
    } finally {
      setLoading(false);
    }
  };
  const [selectedUserType, setSelectedUserType] = useState<UserType | null>(null);
  const [isSidebarOpen, setIsSidebarOpen] = useState(true);
  const [copilots, setCopilots] = useState<AgriCopilot[]>([]);
  const [farmers, setFarmers] = useState<any[]>([]);
  const [vendors, setVendors] = useState<any[]>([]);
  const [buyers, setBuyers] = useState<any[]>([]);
  const [landowners, setLandowners] = useState<any[]>([]);
  const [consumers, setConsumers] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [formSubmitting, setFormSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [showEmployeeForm, setShowEmployeeForm] = useState(false);
  const [isEditMode, setIsEditMode] = useState(false);
  const [selectedEmployee, setSelectedEmployee] = useState<Employee | null>(null);
  const notifications = [
    { id: '1', type: 'onboarding', message: 'New farmer registration pending', userType: 'Admin', time: '2 mins ago', read: false },
    { id: '2', type: 'activity', message: 'New order placed by vendor Fresh Farms', userType: 'Admin', time: '1 hour ago', read: false },
    { id: '3', type: 'onboarding', message: 'New landowner verification required', userType: 'Admin', time: '3 hours ago', read: true },
  ];
  const [uploadType, setUploadType] = useState<'single' | 'bulk'>('single');
  const [uploadProgress, setUploadProgress] = useState<number>(0);
  const [isUploading, setIsUploading] = useState<boolean>(false);
  const fileInputRef = useRef<HTMLInputElement>(null);
  const router = useRouter();
  
  // State for copilot details modal
  const [selectedCopilot, setSelectedCopilot] = useState<AgriCopilot | null>(null);
  const [showCopilotDetails, setShowCopilotDetails] = useState(false);
  
  // State for other user type detail modals
  const [selectedDetailUser, setSelectedDetailUser] = useState<any>(null);
  const [showUserDetails, setShowUserDetails] = useState(false); 

  // Additional state declarations that were misplaced
  const [onboardingUsers, setOnboardingUsers] = useState<User[]>([]);
  const [selectedUser, setSelectedUser] = useState<User | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [locationFilter, setLocationFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [showOnboarding, setShowOnboarding] = useState(false);
  const [selectedState, setSelectedState] = useState('all');
  const [selectedDistrict, setSelectedDistrict] = useState('all');
  const [availableDistricts, setAvailableDistricts] = useState<string[]>([]);
  const [renderCounter, setRenderCounter] = useState(0);
  const [showDownloadMenu, setShowDownloadMenu] = useState(false);

  // Fetch copilots data when onboarding view is shown
  const fetchCopilots = async () => {
    try {
      setLoading(true);
      setError(null);
      console.log('Fetching AgriCopilots from:', `${API_BASE_URL}/admin/agri-copilots`);
      
      const response = await fetch(`${API_BASE_URL}/admin/agri-copilots`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          // Add authorization header if needed
          // 'Authorization': `Bearer ${localStorage.getItem('access_token')}`
        }
      });
      
      console.log('API Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`Failed to fetch copilots: ${response.status} ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Fetched copilots data:', data);
      console.log('Setting copilots state with:', data);
      setCopilots(data);
      setRenderCounter(prev => prev + 1); // Force re-render
      console.log('Copilots state should be updated now');
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'Failed to fetch copilots';
      setError(errorMessage);
      console.error('Error fetching copilots:', err);
    } finally {
      setLoading(false);
    }
  };

  const fetchFarmers = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_BASE_URL}/admin/farmers`);
      if (!res.ok) throw new Error(`Failed to fetch farmers: ${res.status}`);
      const data = await res.json();
      setFarmers(data);
      console.log('‚úÖ Fetched farmers:', data.length);
      // Debug: Log first farmer's data to check document URLs
      if (data.length > 0) {
        console.log('üìä First farmer data:', {
          name: data[0].full_name,
          email: data[0].email,
          aadhar_number: data[0].aadhar_number,
          photo_url: data[0].photo_url,
          aadhar_front_url: data[0].aadhar_front_url,
          verification_status: data[0].verification_status
        });
      }
    } catch (e) {
      console.error('‚ùå Error fetching farmers:', e);
      setFarmers([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchVendors = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_BASE_URL}/admin/vendors`);
      if (!res.ok) throw new Error(`Failed to fetch vendors: ${res.status}`);
      const data = await res.json();
      setVendors(data);
      console.log('‚úÖ Fetched vendors:', data.length);
      // Debug: Log first vendor's data to check document URLs
      if (data.length > 0) {
        console.log('üìä First vendor data:', {
          name: data[0].full_name || data[0].name,
          email: data[0].email,
          aadhar_number: data[0].aadhar_number,
          photo_url: data[0].photo_url,
          aadhar_front_url: data[0].aadhar_front_url,
          verification_status: data[0].verification_status
        });
      }
    } catch (e) {
      console.error('‚ùå Error fetching vendors:', e);
      setVendors([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchBuyers = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_BASE_URL}/admin/buyers`);
      if (!res.ok) throw new Error(`Failed to fetch buyers: ${res.status}`);
      const data = await res.json();
      setBuyers(data);
      console.log('‚úÖ Fetched buyers:', data.length);
      // Debug: Log first buyer's data to check document URLs
      if (data.length > 0) {
        console.log('üìä First buyer data:', {
          name: data[0].full_name || data[0].name,
          email: data[0].email,
          aadhar_number: data[0].aadhar_number,
          photo_url: data[0].photo_url,
          aadhar_front_url: data[0].aadhar_front_url,
          verification_status: data[0].verification_status
        });
      }
    } catch (e) {
      console.error('‚ùå Error fetching buyers:', e);
      setBuyers([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchLandowners = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_BASE_URL}/admin/landowners`);
      if (!res.ok) throw new Error(`Failed to fetch landowners: ${res.status}`);
      const data = await res.json();
      setLandowners(data);
      console.log('‚úÖ Fetched landowners:', data.length);
      // Debug: Log first landowner's data to check document URLs
      if (data.length > 0) {
        console.log('üìä First landowner data:', {
          name: data[0].full_name || data[0].name,
          email: data[0].email,
          aadhar_number: data[0].aadhar_number,
          photo_url: data[0].photo_url,
          aadhar_front_url: data[0].aadhar_front_url,
          verification_status: data[0].verification_status
        });
      }
    } catch (e) {
      console.error('‚ùå Error fetching landowners:', e);
      setLandowners([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchConsumers = async () => {
    try {
      setLoading(true);
      const res = await fetch(`${API_BASE_URL}/admin/consumers`);
      if (!res.ok) throw new Error(`Failed to fetch consumers: ${res.status}`);
      const data = await res.json();
      setConsumers(data);
      console.log('‚úÖ Fetched consumers:', data.length);
      // Debug: Log first consumer's data to check document URLs
      if (data.length > 0) {
        console.log('üìä First consumer data:', {
          name: data[0].full_name || data[0].name,
          email: data[0].email,
          aadhar_number: data[0].aadhar_number,
          photo_url: data[0].photo_url,
          aadhar_front_url: data[0].aadhar_front_url,
          verification_status: data[0].verification_status
        });
      }
    } catch (e) {
      console.error('‚ùå Error fetching consumers:', e);
      setConsumers([]);
    } finally {
      setLoading(false);
    }
  };

  // Download functions
  const handleDownloadExcel = () => {
    try {
      // Get the appropriate user list based on selected user type
      let userList: any[] = [];
      let fileName = '';
      
      if (selectedUserType === 'agricopilot') {
        userList = copilots;
        fileName = 'AgriCopilots_Report';
      } else if (selectedUserType === 'farmer') {
        userList = farmers;
        fileName = 'Farmers_Report';
      } else if (selectedUserType === 'landowner') {
        userList = landowners;
        fileName = 'Landowners_Report';
      } else if (selectedUserType === 'vendor') {
        userList = vendors;
        fileName = 'Vendors_Report';
      } else if (selectedUserType === 'buyer') {
        userList = buyers;
        fileName = 'Buyers_Report';
      } else if (selectedUserType === 'consumer') {
        userList = consumers;
        fileName = 'Consumers_Report';
      }

      // Prepare data for Excel
      const excelData = userList.map(user => ({
        'ID': user.custom_id,
        'Name': user.full_name,
        'Email': user.email,
        'Phone': user.phone,
        'Location': user.location || 'N/A',
        'Status': user.verification_status,
        'Registration Date': new Date(user.created_at).toLocaleDateString()
      }));

      // Create workbook and worksheet
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Users');

      // Auto-size columns
      const maxWidth = 20;
      const wscols = [
        { wch: 12 }, // ID
        { wch: maxWidth }, // Name
        { wch: maxWidth }, // Email
        { wch: 15 }, // Phone
        { wch: 15 }, // State
        { wch: 15 }, // District
        { wch: 12 }, // Status
        { wch: 15 }  // Date
      ];
      ws['!cols'] = wscols;

      // Generate Excel file
      XLSX.writeFile(wb, `${fileName}_${new Date().toISOString().split('T')[0]}.xlsx`);
      setShowDownloadMenu(false);
    } catch (error) {
      console.error('Error generating Excel:', error);
      alert('Failed to generate Excel file');
    }
  };

  const handleDownloadPDF = () => {
    // Get the appropriate user list
    let userList: any[] = [];
    let title = '';
    
    if (selectedUserType === 'agricopilot') {
      userList = copilots;
      title = 'AgriCopilots Report';
    } else if (selectedUserType === 'farmer') {
      userList = farmers;
      title = 'Farmers Report';
    } else if (selectedUserType === 'landowner') {
      userList = landowners;
      title = 'Landowners Report';
    } else if (selectedUserType === 'vendor') {
      userList = vendors;
      title = 'Vendors Report';
    } else if (selectedUserType === 'buyer') {
      userList = buyers;
      title = 'Buyers Report';
    } else if (selectedUserType === 'consumer') {
      userList = consumers;
      title = 'Consumers Report';
    }

    // Create a printable HTML content
    const printContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>${title}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 20px;
            }
            h1 {
              color: #16a34a;
              text-align: center;
              margin-bottom: 10px;
            }
            .date {
              text-align: center;
              color: #666;
              margin-bottom: 20px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
            }
            th {
              background-color: #16a34a;
              color: white;
              padding: 12px;
              text-align: left;
              border: 1px solid #ddd;
            }
            td {
              padding: 10px;
              border: 1px solid #ddd;
            }
            tr:nth-child(even) {
              background-color: #f9f9f9;
            }
            .status-approved {
              color: #16a34a;
              font-weight: bold;
            }
            .status-pending {
              color: #ea580c;
              font-weight: bold;
            }
            .status-rejected {
              color: #dc2626;
              font-weight: bold;
            }
          </style>
        </head>
        <body>
          <h1>${title}</h1>
          <div class="date">Generated on: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Location</th>
                <th>Status</th>
                <th>Registration Date</th>
              </tr>
            </thead>
            <tbody>
              ${userList.map(user => `
                <tr>
                  <td>${user.custom_id}</td>
                  <td>${user.full_name}</td>
                  <td>${user.email}</td>
                  <td>${user.phone}</td>
                  <td>${user.location || 'N/A'}</td>
                  <td class="status-${user.verification_status}">${user.verification_status}</td>
                  <td>${new Date(user.created_at).toLocaleDateString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </body>
      </html>
    `;

    // Open print dialog
    const printWindow = window.open('', '_blank');
    if (printWindow) {
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    }
    setShowDownloadMenu(false);
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    if (uploadType === 'single' && files.length > 0) {
      // Handle single file upload
      const file = files[0];
      console.log('Uploading single file:', file.name);
      await processSingleFile(file);
    } else if (uploadType === 'bulk') {
      // Handle bulk file upload
      console.log('Uploading multiple files:', files.length);
      await processBulkFiles(Array.from(files));
    }

    // Reset the file input
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  const triggerFileInput = () => {
    if (fileInputRef.current) {
      fileInputRef.current.click();
    }
  };

  // Helper function to check if file is supported
  const isSupportedFile = (file: File): boolean => {
    const fileName = file.name.toLowerCase();
    return fileName.endsWith('.csv') || fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
  };

  // Helper function to parse file content (CSV or Excel)
  const parseFileContent = async (file: File): Promise<any[]> => {
    const fileName = file.name.toLowerCase();
    
    if (fileName.endsWith('.csv')) {
      const text = await file.text();
      return parseCSV(text);
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
      return parseExcel(file);
    } else {
      throw new Error('Unsupported file format');
    }
  };

  // Parse Excel files
  const parseExcel = async (file: File): Promise<any[]> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target?.result as ArrayBuffer);
          const workbook = XLSX.read(data, { type: 'array' });
          
          // Get the first worksheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          
          // Convert to JSON with header row
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          if (jsonData.length < 2) {
            resolve([]); // Need at least header + 1 data row
            return;
          }
          
          const headers = (jsonData[0] as any[]).map((h: any) => {
            if (h === null || h === undefined) return '';
            return String(h).toLowerCase().trim().replace(/["\s]/g, '');
          });
          
          // Find column indices with flexible matching (same logic as CSV)
          const getColumnIndex = (possibleNames: string[]) => {
            for (const name of possibleNames) {
              const normalizedName = name.toLowerCase().replace(/[_\s]/g, '');
              const index = headers.findIndex(h => {
                if (!h || typeof h !== 'string') return false;
                const normalizedHeader = h.toLowerCase().replace(/[_\s]/g, '');
                return normalizedHeader === normalizedName || 
                       normalizedHeader.includes(normalizedName) || 
                       normalizedName.includes(normalizedHeader);
              });
              if (index !== -1) return index;
            }
            return -1;
          };

          const nameIndex = getColumnIndex(['name', 'fullname', 'full_name', 'fname']);
          const emailIndex = getColumnIndex(['email', 'mail', 'e_mail']);
          const phoneIndex = getColumnIndex(['phone', 'mobile', 'contact', 'number']);
          const memberTypeIndex = getColumnIndex(['member_type', 'membertype', 'type', 'role']);
          
          // Check if required columns are found
          if (nameIndex === -1 || emailIndex === -1 || phoneIndex === -1) {
            const missing = [];
            if (nameIndex === -1) missing.push('name/full_name');
            if (emailIndex === -1) missing.push('email');
            if (phoneIndex === -1) missing.push('phone');
            const headerDisplay = (jsonData[0] as any[]).map((h: any) => String(h).trim()).join(', ');
            reject(new Error(`Missing required columns: ${missing.join(', ')}. Found columns: ${headerDisplay}`));
            return;
          }
          
          const users = [];
          
          for (let i = 1; i < jsonData.length; i++) {
            const row = jsonData[i] as any[];
            if (row.length === 0 || !row.some(cell => cell !== null && cell !== undefined && cell !== '')) {
              continue; // Skip empty rows
            }
            
            const rawMemberType = memberTypeIndex >= 0 && row[memberTypeIndex] ? String(row[memberTypeIndex]).trim() : null;
            const normalizedType = normalizeMemberType(rawMemberType) || normalizeMemberType(selectedUserType || 'agricopilot') || 'agri_copilot';

            const user: any = {
              full_name: nameIndex >= 0 && row[nameIndex] !== null && row[nameIndex] !== undefined ? String(row[nameIndex]).trim() : '',
              email: emailIndex >= 0 && row[emailIndex] !== null && row[emailIndex] !== undefined ? String(row[emailIndex]).trim().toLowerCase() : '',
              phone: phoneIndex >= 0 && row[phoneIndex] !== null && row[phoneIndex] !== undefined ? String(row[phoneIndex]).trim() : '',
              member_type: normalizedType
            };
            
            // Validate required fields
            if (user.full_name && user.email && user.phone) {
              // Basic email validation
              if (user.email.includes('@') && user.email.includes('.')) {
                // Clean phone number (remove any formatting)
                user.phone = user.phone.replace(/\D/g, '');
                
                // Ensure phone number is in correct format
                if (user.phone.length >= 10) {
                  // Keep last 10 digits for Indian mobile numbers
                  if (user.phone.length > 10) {
                    user.phone = user.phone.slice(-10);
                  }
                  users.push(user);
                }
              }
            }
          }
          
          resolve(users);
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = () => reject(new Error('Failed to read Excel file'));
      reader.readAsArrayBuffer(file);
    });
  };

  // Process single file (CSV or Excel)
  const processSingleFile = async (file: File) => {
    if (!isSupportedFile(file)) {
      alert('Please upload CSV or Excel files (.csv, .xlsx, .xls) only.');
      return;
    }

    try {
      const users = await parseFileContent(file);
      
      if (users.length === 0) {
        alert('The file appears to be empty or invalid.');
        return;
      }

      await uploadUsers(users, file.name);
    } catch (error) {
      console.error('Error processing file:', error);
      alert(`Failed to process ${file.name}. Please check the file format.`);
    }
  };

  // Process multiple files for bulk upload (CSV and Excel)
  const processBulkFiles = async (files: File[]) => {
    const supportedFiles = files.filter(file => isSupportedFile(file));
    
    if (supportedFiles.length === 0) {
      alert('Please upload at least one CSV or Excel file.');
      return;
    }

    if (supportedFiles.length !== files.length) {
      alert(`Only CSV and Excel files are supported. Processing ${supportedFiles.length} out of ${files.length} files.`);
    }

    setIsUploading(true);
    setUploadProgress(0);
    setLoading(true);
    let totalProcessed = 0;
    let totalFailed = 0;

    for (let i = 0; i < supportedFiles.length; i++) {
      const file = supportedFiles[i];
      try {
        const users = await parseFileContent(file);
        
        if (users.length > 0) {
          await uploadUsers(users, file.name);
          totalProcessed += users.length;
        }
        
        // Update progress
        setUploadProgress(((i + 1) / supportedFiles.length) * 100);
      } catch (error) {
        console.error(`Error processing file ${file.name}:`, error);
        totalFailed++;
        alert(`Failed to process ${file.name}`);
      }
    }

    setIsUploading(false);
    setUploadProgress(100);
    setLoading(false);
    
    alert(`Successfully processed ${totalProcessed} users from ${supportedFiles.length - totalFailed} files.`);
  };

  // Parse CSV content to user objects
  const parseCSV = (csvText: string) => {
    const lines = csvText.trim().split('\n');
    if (lines.length < 2) return []; // Need at least header + 1 data row
    
    const headers = lines[0].split(',').map(h => {
      if (!h) return '';
      return h.trim().toLowerCase().replace(/["\s]/g, '');
    });
    const users = [];
    
    // Find column indices with flexible matching
    const getColumnIndex = (possibleNames: string[]) => {
      for (const name of possibleNames) {
        const normalizedName = name.toLowerCase().replace(/[_\s]/g, '');
        const index = headers.findIndex(h => {
          if (!h || typeof h !== 'string') return false;
          const normalizedHeader = h.toLowerCase().replace(/[_\s]/g, '');
          return normalizedHeader === normalizedName || 
                 normalizedHeader.includes(normalizedName) || 
                 normalizedName.includes(normalizedHeader);
        });
        if (index !== -1) return index;
      }
      return -1;
    };

    const nameIndex = getColumnIndex(['name', 'fullname', 'full_name', 'fname']);
    const emailIndex = getColumnIndex(['email', 'mail', 'e_mail']);
    const phoneIndex = getColumnIndex(['phone', 'mobile', 'contact', 'number']);
  const memberTypeIndex = getColumnIndex(['member_type', 'membertype', 'type', 'role']);
    
    // Check if required columns are found
    if (nameIndex === -1 || emailIndex === -1 || phoneIndex === -1) {
      const missing = [];
      if (nameIndex === -1) missing.push('name/full_name');
      if (emailIndex === -1) missing.push('email');
      if (phoneIndex === -1) missing.push('phone');
      throw new Error(`Missing required columns: ${missing.join(', ')}. Found columns: ${lines[0].split(',').map(h => h.trim()).join(', ')}`);
    }
    
    for (let i = 1; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue; // Skip empty lines
      
      // Handle CSV parsing with proper quote handling
      const values: string[] = [];
      let current = '';
      let inQuotes = false;
      
      for (let j = 0; j < line.length; j++) {
        const char = line[j];
        
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim().replace(/^"|"$/g, ''));
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim().replace(/^"|"$/g, ''));
      
      if (values.length < Math.max(nameIndex, emailIndex, phoneIndex) + 1) continue; // Skip malformed rows
      
      const rawMemberType = memberTypeIndex >= 0 && values[memberTypeIndex] ? values[memberTypeIndex].trim() : null;
      const normalizedType = normalizeMemberType(rawMemberType) || normalizeMemberType(selectedUserType || 'agricopilot') || 'agri_copilot';

      const user: any = {
        full_name: nameIndex >= 0 ? values[nameIndex]?.trim() : '',
        email: emailIndex >= 0 ? values[emailIndex]?.trim().toLowerCase() : '',
        phone: phoneIndex >= 0 ? values[phoneIndex]?.trim() : '',
        member_type: normalizedType
      };
      
      // Validate required fields
      if (user.full_name && user.email && user.phone) {
        // Basic email validation
        if (user.email.includes('@') && user.email.includes('.')) {
          // Clean phone number (remove any formatting)
          user.phone = user.phone.replace(/\D/g, '');
          
          // Ensure phone number is in correct format
          if (user.phone.length >= 10) {
            // Keep last 10 digits for Indian mobile numbers
            if (user.phone.length > 10) {
              user.phone = user.phone.slice(-10);
            }
            users.push(user);
          }
        }
      }
    }
    
    return users;
  };

  // Upload users via API
  const uploadUsers = async (users: any[], fileName: string) => {
    const token = localStorage.getItem('access_token') || localStorage.getItem('authToken') || localStorage.getItem('token');
    
    if (!token) {
      alert('Please login again to continue.');
      return;
    }

    try {
      // Group users by member_type and send separate requests for each type
      const usersByType = users.reduce((acc: Record<string, any[]>, user) => {
        const normalized = normalizeMemberType(user.member_type) || normalizeMemberType(selectedUserType || 'agricopilot');
        if (!normalized) {
          console.warn('Skipping user with unsupported member_type:', user.member_type, user.email);
          return acc; // skip unknown types
        }
        if (!acc[normalized]) acc[normalized] = [];
        acc[normalized].push(user);
        return acc;
      }, {});

      // Process each member type separately
      for (const [memberType, typeUsers] of Object.entries(usersByType)) {
        if (!BACKEND_MEMBER_TYPES.includes(memberType)) {
          console.warn('Skipping unsupported backend member type:', memberType);
          continue;
        }
        // Create FormData to send files to the backend (backend expects files, not JSON)
        const formData = new FormData();
        
        // Create a CSV blob from the users data
        const csvHeaders = 'full_name,email,phone\n';
        const csvData = typeUsers.map(user => 
          `"${user.full_name}","${user.email}","${user.phone}"`
        ).join('\n');
        const csvContent = csvHeaders + csvData;
        
        const csvBlob = new Blob([csvContent], { type: 'text/csv' });
        const csvFile = new File([csvBlob], `${fileName}_${memberType}.csv`, { type: 'text/csv' });
        
        // FIXED: Backend expects 'file' (singular), not 'files'
        formData.append('file', csvFile);

        console.log(`Uploading ${typeUsers.length} ${memberType} users from ${fileName}`);

        const response = await fetch(`${API_BASE_URL}/admin/bulk-upload/${memberType}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
            // Don't set Content-Type for FormData, let browser set it with boundary
          },
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.text();
          throw new Error(`Upload failed for ${memberType}: ${response.status} ${errorData}`);
        }

        const result = await response.json();
        console.log(`Bulk upload result for ${memberType}:`, result);
        
        // Show detailed results to user
        if (result.errors && result.errors.length > 0) {
          console.error(`‚ùå Upload errors for ${memberType}:`, result.errors);
          alert(`Upload Summary for ${memberType}:\n\n‚úÖ Success: ${result.successful_uploads}/${result.total_rows}\n‚ùå Failed: ${result.failed_uploads}\n\nErrors:\n${result.errors.join('\n')}\n\n${result.password_info || ''}`);
        }
      }
      
      alert(`Successfully processed ${users.length} users from ${fileName}`);

      // Refresh data after successful upload
      await fetchCounts();
      
    } catch (error) {
      console.error('Error uploading users:', error);
      alert(`Failed to upload users from ${fileName}. Error: ${error instanceof Error ? error.message : 'Unknown error'}`);
      throw error; // Re-throw to handle in calling function
    }
  };

  // Handle viewing copilot details
  const handleViewCopilotDetails = (copilot: AgriCopilot) => {
    setSelectedCopilot(copilot);
    setShowCopilotDetails(true);
  };

  // Close copilot details modal
  const closeCopilotDetails = () => {
    setSelectedCopilot(null);
    setShowCopilotDetails(false);
  };
  
  // Handle viewing other user type details (Farmer, Landowner, Buyer, Vendor)
  const handleViewUserDetails = (user: any) => {
    console.log('üëÅÔ∏è Viewing user details:', {
      userType: selectedUserType,
      name: user.full_name || user.name,
      email: user.email,
      aadhar_number: user.aadhar_number,
      photo_url: user.photo_url,
      aadhar_front_url: user.aadhar_front_url,
      verification_status: user.verification_status || user.status
    });
    setSelectedDetailUser(user);
    setShowUserDetails(true);
  };

  // Close user details modal
  const closeUserDetails = () => {
    setSelectedDetailUser(null);
    setShowUserDetails(false);
  };

  // Render copilots table
  const renderCopilotTable = () => {
    const handleViewDetails = (copilot: AgriCopilot) => {
      // You can implement the view details modal here
      console.log('View details for:', copilot);
    };

    return (
      <div className="bg-white rounded-lg shadow">
        <div className="px-6 py-4 border-b border-gray-200">
          <h2 className="text-xl font-semibold text-gray-900">AgriCopilot Management</h2>
          <p className="mt-1 text-sm text-gray-500">Manage employee registrations and activities</p>
        </div>

        <div className="p-6">
          <div className="flex justify-end mb-6 gap-4">
            <button
              onClick={() => {
                setSelectedUserType('agricopilot');
                setActiveTab('addEmployee');
                setShowEmployeeForm(true);
              }}
              className="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              <Plus className="w-4 h-4 mr-2" />
              Add Employee
            </button>
          </div>

          <AgriCopilotTable
            copilots={copilots}
            onViewDetails={handleViewDetails}
            loading={loading}
            error={error}
          />
        </div>
      </div>
    );
  };

  // Dynamic user counts fetched from backend
  type StatsShape = { total: number; active: number; verified?: number; pending?: number };
  const [userStats, setUserStats] = useState<Record<UserType, StatsShape>>({
    agricopilot: { total: 0, active: 0, verified: 0, pending: 0 },
    farmer: { total: 0, active: 0, verified: 0, pending: 0 },
    landowner: { total: 0, active: 0, verified: 0, pending: 0 },
    vendor: { total: 0, active: 0, verified: 0, pending: 0 },
    buyer: { total: 0, active: 0, verified: 0, pending: 0 },
    consumer: { total: 0, active: 0, verified: 0, pending: 0 }
  });

  const fetchCounts = async () => {
    try {
      // Map user types to backend endpoints
      const endpoints: Partial<Record<UserType, string>> = {
        agricopilot: `${API_BASE_URL}/admin/agri-copilots`,
        farmer: `${API_BASE_URL}/admin/farmers`,
        landowner: `${API_BASE_URL}/admin/landowners`,
        vendor: `${API_BASE_URL}/admin/vendors`,
        buyer: `${API_BASE_URL}/admin/buyers`,
        consumer: `${API_BASE_URL}/admin/consumers`,
      };

      const entries = await Promise.all(Object.entries(endpoints).map(async ([key, url]) => {
        try {
          const res = await fetch(url as string, { method: 'GET' });
          if (!res.ok) {
            console.warn(`Failed to fetch ${key} from ${url}:`, res.statusText);
            return [key, { total: 0, active: 0 }];
          }
          const data = await res.json();
          // data is expected to be an array of records
          const total = Array.isArray(data) ? data.length : 0;
          // Use total as active for now if backend doesn't expose active/verified counts
          const active = total;
          // If fetching agri-copilots, compute verified/pending from verification_status
          if (key === 'agricopilot' && Array.isArray(data)) {
            const verified = data.filter((d: any) => d.verification_status === 'approved').length;
            const pending = data.filter((d: any) => d.verification_status === 'pending').length;
            return [key, { total, active, verified, pending }];
          }
          return [key, { total, active, verified: 0, pending: 0 }];
        } catch (err) {
          console.error(`Error fetching ${key}:`, err);
          return [key, { total: 0, active: 0 }];
        }
      }));

      const newStats = { ...userStats };
      for (const [k, v] of entries as Array<[string, { total: number; active: number }]>) {
        // Only set keys that exist in our state
        if (k in newStats) {
          (newStats as any)[k] = v;
        }
      }
      setUserStats(newStats);
    } catch (err) {
      console.error('Error fetching counts:', err);
    }
  };

  // Fetch counts and all user data on mount for dashboard
  useEffect(() => {
    fetchCounts();
    
    // Fetch all user data for dashboard stats
    fetchCopilots();
    fetchFarmers();
    fetchLandowners();
    fetchVendors();
    fetchBuyers();
    fetchConsumers();
    
    // Optional: refresh periodically or when tab becomes active
  }, []);

  // Indian states and districts data
  const indianStates = [
    'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh',
    'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jharkhand',
    'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur',
    'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab',
    'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura',
    'Uttar Pradesh', 'Uttarakhand', 'West Bengal'
  ];

  const districtsByState = {
    'Andhra Pradesh': ['Visakhapatnam', 'Vijayawada', 'Guntur', 'Nellore', 'Kurnool'],
    'Arunachal Pradesh': ['Itanagar', 'Naharlagun', 'Pasighat', 'Tezpur', 'Bomdila'],
    'Assam': ['Guwahati', 'Silchar', 'Dibrugarh', 'Jorhat', 'Nagaon'],
    'Bihar': ['Patna', 'Gaya', 'Bhagalpur', 'Muzaffarpur', 'Darbhanga'],
    'Chhattisgarh': ['Raipur', 'Bhilai', 'Bilaspur', 'Korba', 'Rajnandgaon'],
    'Goa': ['Panaji', 'Margao', 'Vasco da Gama', 'Mapusa', 'Ponda'],
    'Gujarat': ['Ahmedabad', 'Surat', 'Vadodara', 'Rajkot', 'Bhavnagar'],
    'Haryana': ['Gurgaon', 'Faridabad', 'Panipat', 'Ambala', 'Karnal'],
    'Himachal Pradesh': ['Shimla', 'Mandi', 'Solan', 'Dharamshala', 'Baddi'],
    'Jharkhand': ['Ranchi', 'Jamshedpur', 'Dhanbad', 'Bokaro', 'Deoghar'],
    'Karnataka': ['Bangalore', 'Mysore', 'Hubli', 'Mangalore', 'Belgaum'],
    'Kerala': ['Thiruvananthapuram', 'Kochi', 'Kozhikode', 'Thrissur', 'Kollam'],
    'Madhya Pradesh': ['Bhopal', 'Indore', 'Gwalior', 'Jabalpur', 'Ujjain'],
    'Maharashtra': ['Mumbai', 'Pune', 'Nagpur', 'Nashik', 'Aurangabad'],
    'Manipur': ['Imphal', 'Thoubal', 'Bishnupur', 'Churachandpur', 'Senapati'],
    'Meghalaya': ['Shillong', 'Tura', 'Jowai', 'Nongpoh', 'Baghmara'],
    'Mizoram': ['Aizawl', 'Lunglei', 'Saiha', 'Champhai', 'Kolasib'],
    'Nagaland': ['Kohima', 'Dimapur', 'Mokokchung', 'Tuensang', 'Wokha'],
    'Odisha': ['Bhubaneswar', 'Cuttack', 'Rourkela', 'Berhampur', 'Sambalpur'],
    'Punjab': ['Chandigarh', 'Ludhiana', 'Amritsar', 'Jalandhar', 'Patiala'],
    'Rajasthan': ['Jaipur', 'Jodhpur', 'Udaipur', 'Kota', 'Ajmer'],
    'Sikkim': ['Gangtok', 'Namchi', 'Mangan', 'Gyalshing', 'Singtam'],
    'Tamil Nadu': ['Chennai', 'Coimbatore', 'Madurai', 'Tiruchirappalli', 'Salem'],
    'Telangana': ['Hyderabad', 'Warangal', 'Nizamabad', 'Khammam', 'Karimnagar'],
    'Tripura': ['Agartala', 'Dharmanagar', 'Kailashahar', 'Belonia', 'Khowai'],
    'Uttar Pradesh': ['Lucknow', 'Kanpur', 'Agra', 'Varanasi', 'Meerut'],
    'Uttarakhand': ['Dehradun', 'Haridwar', 'Roorkee', 'Kashipur', 'Rudrapur'],
    'West Bengal': ['Kolkata', 'Howrah', 'Durgapur', 'Asansol', 'Siliguri']
  };

  // State for onboarding management

  const statuses = ['all', 'pending', 'verified'];

// Define interfaces at the top
interface Employee {
  id: number;
  name: string;
  email: string;
  role: string;
  department: string;
  joinDate: string;
  status: 'active' | 'inactive';
}

interface User {
  id: number;
  name: string;
  email: string;
  phone: string;
  date: string;
  status: 'pending' | 'verified';
  location: string;
  type: UserType;
  state?: string;
  district?: string;
  availability?: 'available' | 'unavailable';
}



const formTitle = selectedUserType === 'agricopilot' 
  ? 'Agricopilot Registration'
  : selectedUserType === 'consumer'
  ? 'Consumer Registration'
  : 'User Registration';

// Filter users based on search and filters
const filteredUsers = onboardingUsers.filter(user => {
  const matchesSearch = user.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                       user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||
                       user.phone.includes(searchTerm);
  const matchesLocation = locationFilter === 'all' || user.location.toLowerCase().includes(locationFilter.toLowerCase());
  const matchesStatus = statusFilter === 'all' || user.availability === statusFilter;
  const matchesType = !selectedUserType || user.type === selectedUserType;
  const matchesState = selectedState === 'all' || (user.state && user.state === selectedState);
  const matchesDistrict = selectedDistrict === 'all' || (user.district && user.district === selectedDistrict);
  
  return matchesSearch && matchesLocation && matchesStatus && matchesType && matchesState && matchesDistrict;
});

const locations = ['all', ...Array.from(new Set(onboardingUsers.map(user => user.location)))];

// Update districts when state changes
React.useEffect(() => {
  if (selectedState === 'all') {
    setAvailableDistricts([]);
    setSelectedDistrict('all');
  } else {
    setAvailableDistricts(districtsByState[selectedState as keyof typeof districtsByState] || []);
    setSelectedDistrict('all');
  }
}, [selectedState]);

  // Fetch data when showing onboarding view
  useEffect(() => {
    if (!showOnboarding) return;

    // Fetch based on selected user type
    switch (selectedUserType) {
      case 'farmer':
        if (farmers.length === 0) fetchFarmers();
        break;
      case 'vendor':
        if (vendors.length === 0) fetchVendors();
        break;
      case 'buyer':
        if (buyers.length === 0) fetchBuyers();
        break;
      case 'landowner':
        if (landowners.length === 0) fetchLandowners();
        break;
      default:
        if (copilots.length === 0) fetchCopilots();
    }
  }, [showOnboarding]);

  // Debug useEffect to track copilots state changes
  useEffect(() => {
    console.log('Copilots state changed:', copilots.length, copilots);
  }, [copilots]);/* Removed duplicate declaration of statuses */

// Handle user verification
const handleVerifyUser = (userId: number) => {
  setOnboardingUsers(users => 
    users.map(user => 
      user.id === userId ? { ...user, status: 'verified' as const, availability: 'available' as const } : user
    )
  );
  // Show success message
  alert('User has been verified and is now available!');
};

// View user details
const handleViewDetails = (user: User) => {
  setSelectedUser(user);
};

// Close user details modal
const handleCloseDetails = () => {
  setSelectedUser(null);
};

// Send verification email
const handleSendVerificationEmail = (user: User) => {
  console.log('Sending verification email to:', user.email);
  alert(`Verification email sent to ${user.email}`);
};

// Toggle onboarding view
const toggleOnboardingView = () => {
  setShowOnboarding(!showOnboarding);
};

  const [showForm, setShowForm] = useState(false);
  const [formData, setFormData] = useState({
    fullName: '',
    email: '',
    phone: ''
  });

  // Define custom SVG components
  const Store = ({ className = '' }: { className?: string }) => (
    <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
    </svg>
  );

  const ShoppingBag = ({ className = '' }: { className?: string }) => (
    <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
  );

  const userTypes = [
    { 
      id: 'agricopilot' as const, 
      label: 'AgriCoPilot', 
      icon: UserCheck, 
      color: 'bg-green-100 text-green-700',
      bgImage: '/agricopilot-bg.jpg',
      iconImage: '/agricopilot-bg.jpg'
    },
    { 
      id: 'farmer' as const, 
      label: 'Farmer', 
      icon: Users, 
      color: 'bg-blue-100 text-blue-700',
      bgImage: '/farmer-bg.jpg',
      iconImage: '/farmer-bg.jpg'
    },
    { 
      id: 'landowner' as const, 
      label: 'Landowner', 
      icon: MapPin, 
      color: 'bg-yellow-100 text-yellow-700',
      bgImage: '/landowner-bg.jpg',
      iconImage: '/landowner-bg.jpg'
    },
    { 
      id: 'vendor' as const, 
      label: 'Vendor', 
      icon: Store, 
      color: 'bg-purple-100 text-purple-700',
      bgImage: '/vendor-bg.jpg',
      iconImage: '/vendor-bg.jpg'
    },
    { 
      id: 'buyer' as const, 
      label: 'Buyer', 
      icon: ShoppingBag, 
      color: 'bg-red-100 text-red-700',
      bgImage: '/buyer-bg.jpg',
      iconImage: '/buyer-bg.jpg'
    },
    { 
      id: 'consumer' as const, 
      label: 'Consumer', 
      icon: Users, 
      color: 'bg-pink-100 text-pink-700',
      bgImage: '/consumer-bg.jpg',
      iconImage: '/consumer-bg.jpg'
    },
  ];

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (formSubmitting) return; // Prevent double submission
    
    try {
      // Validate required fields
      if (!formData.fullName || !formData.email || !formData.phone) {
        alert('Please fill in all required fields');
        return;
      }

      // Validate phone number format - check if it can be cleaned to a valid format
      const cleanedPhone = formData.phone.replace(/\D/g, '');
      let isValidPhone = false;
      
      if (cleanedPhone.length === 10 && /^[6-9]/.test(cleanedPhone)) {
        isValidPhone = true; // 9876543210
      } else if (cleanedPhone.length === 11 && cleanedPhone.startsWith('0') && /^0[6-9]/.test(cleanedPhone)) {
        isValidPhone = true; // 09876543210
      } else if (cleanedPhone.length === 12 && cleanedPhone.startsWith('91') && /^91[6-9]/.test(cleanedPhone)) {
        isValidPhone = true; // 919876543210
      }
      
      if (!isValidPhone) {
        alert('Please enter a valid Indian mobile number. Examples: 9876543210, +919876543210, 09876543210');
        return;
      }

      setFormSubmitting(true);
      console.log('Form submitted:', formData);
      
      // Format phone number to match backend validation
      const formatPhoneNumber = (phone: string): string => {
        if (!phone) return '';
        // Remove all non-digit characters
        const cleaned = phone.replace(/\D/g, '');
        
        // Convert to 10-digit format that backend expects
        if (cleaned.length === 10 && /^[6-9]/.test(cleaned)) {
          return cleaned; // Already in correct format: 9876543210
        } else if (cleaned.length === 11 && cleaned.startsWith('0') && /^0[6-9]/.test(cleaned)) {
          return cleaned.substring(1); // Remove leading 0: 09876543210 -> 9876543210
        } else if (cleaned.length === 12 && cleaned.startsWith('91') && /^91[6-9]/.test(cleaned)) {
          return cleaned.substring(2); // Remove country code: 919876543210 -> 9876543210
        }
        
        // If we can't format it properly, return the cleaned version
        // Backend validation will catch any remaining issues
        return cleaned;
      };

      // Prepare JSON data for the invite API
      const inviteData = {
        full_name: formData.fullName,
        email: formData.email,
        phone: formatPhoneNumber(formData.phone)
      };

      // Map selected user type to invite endpoint

      const endpointMap: Record<string, string> = {
        agricopilot: '/admin/invite/agri-copilot',
        farmer: '/admin/invite/farmer',
        landowner: '/admin/invite/landowner',
        vendor: '/admin/invite/vendor',
        buyer: '/admin/invite/buyer',
      };

      const endpoint = endpointMap[selectedUserType || 'agricopilot'];
      const apiBase = process.env.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:8000';

      if (!endpoint) {
        alert('This user type does not support invitations.');
        setFormSubmitting(false);
        return;
      }

      // Send data to backend API
      console.log('Sending invite request to:', `${apiBase}${endpoint}`);
      console.log('Invite data being sent:', inviteData);
      console.log('Original phone input:', formData.phone);
      console.log('Formatted phone:', formatPhoneNumber(formData.phone));

      const response = await fetch(`${apiBase}${endpoint}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(inviteData),
      });

      if (response.ok) {
        const result = await response.json();
        alert('Invitation sent successfully! The user will receive an email with registration instructions.');
        
        // Reset form
        setFormData({
          fullName: '',
          email: '',
          phone: ''
        });
        
        // Close form or redirect
        setActiveTab('dashboard');
        setShowForm(false);
      } else {
        const error = await response.json();
        console.error('Backend error response:', error);
        
        let errorMessage = 'Failed to send invitation';
        if (error.detail) {
          if (Array.isArray(error.detail)) {
            // FastAPI validation errors
            errorMessage = error.detail.map((err: any) => {
              const field = err.loc?.slice(-1)[0] || 'field';
              return `${field}: ${err.msg}`;
            }).join(', ');
          } else {
            errorMessage = error.detail;
          }
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        alert(`Error: ${errorMessage}`);
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      alert('An error occurred while registering the user. Please try again.');
    } finally {
      setFormSubmitting(false);
    }
  };

const handleLogout = () => {
    // Clear authentication data
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userType');
    localStorage.removeItem('userData');
    
    // --- THIS IS THE FIX ---
    // Remove the keys you actually use to read the token
    localStorage.removeItem('access_token');
    localStorage.removeItem('token'); 
    // You can also leave 'authToken' just in case
    localStorage.removeItem('authToken');
    
    // Clear session storage as well
    sessionStorage.clear();
    
    // If onLogout prop exists, call it
    if (onLogout && typeof onLogout === 'function') {
      onLogout();
    } else {
      // Otherwise, redirect to home page using Next.js router
      router.push('/');
    }
  };

  // Get the current user type icon based on selection
  const currentUserType = userTypes.find(type => type.id === selectedUserType);
  const UserTypeIcon = currentUserType?.icon || User;
  
  // Type guard to check if selectedUserType is not null
  const isUserTypeSelected = (type: UserType | null): type is UserType => {
    return type !== null;
  };
  
  // Safe way to get user stats
  const getUserStats = (type: UserType) => {
    return userStats[type] || { total: 0, active: 0 };
  };

  // Employee management functions
  const handleAddEmployee = () => {
    setShowEmployeeForm(true);
    setIsEditMode(false);
    setSelectedEmployee(null);
  };

  const handleEditEmployee = (employee: Employee) => {
    setShowEmployeeForm(true);
    setIsEditMode(true);
    setSelectedEmployee(employee);
  };

  const handleDeleteEmployee = (employee: Employee) => {
    // Add your delete logic here
    console.log('Deleting employee:', employee);
  };

  return (
    <div className="flex h-screen bg-gray-50">
      {/* Global Topbar */}
      <Topbar
        userName="Admin"
        userEmail="admin@agrihub.com"
        userType="Admin"
        notifications={notifications}
        onLogout={handleLogout}
      />

      {/* Sidebar */}
      <aside className={`fixed top-[64px] left-0 bottom-0 ${isSidebarOpen ? 'w-64' : 'w-20'} bg-white shadow-lg transition-all duration-300 flex flex-col z-10`}>
        <div className="flex-1 overflow-y-auto py-4">
          <div className={`flex flex-col items-center ${isSidebarOpen ? 'px-6' : 'px-2'} space-y-1`}>
            {/* Dashboard Button with Icon */}
            <button 
              onClick={() => {
                setActiveTab('dashboard');
                setSelectedUserType(null);
              }}
              className={`w-full flex items-center ${isSidebarOpen ? 'justify-start px-4' : 'justify-center'} py-3 rounded-lg ${
                activeTab === 'dashboard' ? 'bg-green-50 text-green-700' : 'text-gray-700 hover:bg-gray-100'
              }`}
            >
              <div className="flex items-center space-x-3">
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                </svg>
                {isSidebarOpen && <span>Dashboard</span>}
              </div>
            </button>
            
            
            <div className={`w-full ${isSidebarOpen ? 'mt-6' : 'mt 4'}`}>
              {isSidebarOpen && (
                <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4 mb-2">
                  User Types
                </h3>
              )}
              <div className={`space-y-2 ${!isSidebarOpen ? 'px-2' : ''}`}>
                  {userTypes.map((type) => (
                    <div
                      key={type.id}
                      onClick={() => {
                        // When selecting a user type from the sidebar, do NOT open the add form automatically.
                        // Only the explicit "Add" buttons should open the form.
                        setSelectedUserType(type.id);
                        setActiveTab('addEmployee');
                        setShowEmployeeForm(false);
                      }}
                      className={`flex items-center justify-between p-3 rounded-lg cursor-pointer ${type.color} hover:opacity-90 transition-opacity`}
                    >
                      <div className="flex items-center space-x-3">
                        <div className="relative w-8 h-8 rounded-lg overflow-hidden flex-shrink-0">
                          <img 
                            src={type.iconImage} 
                            alt={type.label}
                            className="w-full h-full object-cover"
                          />
                        </div>
                        <span className="font-medium">{type.label}</span>
                      </div>
                      <ChevronRight className="w-4 h-4 opacity-70" />
                    </div>
                  ))}
                </div>
              </div>
          </div>
        </div>
      </aside>

      {/* Main Content */}
      <main className={`flex-1 overflow-y-auto pt-16 transition-all duration-300 ${isSidebarOpen ? 'ml-64' : 'ml-20'} h-[calc(100vh-4rem)]`}>
        {activeTab === 'onboard' && selectedUserType && (
          <div className="w-full p-6">
            {/* Professional User Management Interface */}
            <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl shadow-lg border border-gray-200 overflow-hidden">
              {/* Main Header */}
              <div className="bg-white px-8 py-6 border-b border-gray-200">
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                  {/* Title Section */}
                  <div className="flex items-center space-x-4">
                    <div className={`p-3 rounded-lg ${
                      selectedUserType === 'agricopilot' ? 'bg-gradient-to-r from-green-500 to-blue-600' :
                      selectedUserType === 'farmer' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :
                      selectedUserType === 'landowner' ? 'bg-gradient-to-r from-yellow-500 to-amber-600' :
                      selectedUserType === 'vendor' ? 'bg-gradient-to-r from-purple-500 to-indigo-600' :
                      'bg-gradient-to-r from-blue-500 to-cyan-600'
                    }`}>
                      <Users className="h-8 w-8 text-white" />
                    </div>
                    <div>
                      <h1 className="text-3xl font-bold text-gray-900">
                        {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)} Management
                      </h1>
                      <p className="text-gray-600 mt-1 text-lg">
                        {selectedUserType === 'agricopilot' ? 'Agricultural Consultant Registration and Onboarding' :
                         selectedUserType === 'farmer' ? 'Farmer Registration and Verification Platform' :
                         selectedUserType === 'landowner' ? 'Landowner Registration and Property Management' :
                         selectedUserType === 'vendor' ? 'Agricultural Vendor Registration and Verification' :
                         'Agricultural Buyer Registration and Management'}
                      </p>
                      <div className="flex items-center mt-2 space-x-4 text-sm text-gray-500">
                        <span className="flex items-center">
                          <div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                          {(() => {
                            if (selectedUserType === 'agricopilot') return `${copilots.filter(c => c.verification_status === 'approved').length} Verified`;
                            if (selectedUserType === 'farmer') return `${farmers.filter(f => f.verification_status === 'approved').length} Verified`;
                            if (selectedUserType === 'landowner') return `${landowners.filter(l => l.verification_status === 'approved').length} Verified`;
                            if (selectedUserType === 'vendor') return `${vendors.filter(v => v.verification_status === 'approved').length} Verified`;
                            if (selectedUserType === 'buyer') return `${buyers.filter(b => b.verification_status === 'approved').length} Verified`;
                            if (selectedUserType === 'consumer') return `${consumers.filter(c => c.verification_status === 'approved').length} Verified`;
                            return '0 Verified';
                          })()}
                        </span>
                        <span className="flex items-center">
                          <div className="w-2 h-2 bg-yellow-500 rounded-full mr-2"></div>
                          {(() => {
                            if (selectedUserType === 'agricopilot') return `${copilots.filter(c => c.verification_status === 'pending').length} Pending`;
                            if (selectedUserType === 'farmer') return `${farmers.filter(f => f.verification_status === 'pending').length} Pending`;
                            if (selectedUserType === 'landowner') return `${landowners.filter(l => l.verification_status === 'pending').length} Pending`;
                            if (selectedUserType === 'vendor') return `${vendors.filter(v => v.verification_status === 'pending').length} Pending`;
                            if (selectedUserType === 'buyer') return `${buyers.filter(b => b.verification_status === 'pending').length} Pending`;
                            if (selectedUserType === 'consumer') return `${consumers.filter(c => c.verification_status === 'pending').length} Pending`;
                            return '0 Pending';
                          })()}
                        </span>
                        <span className="flex items-center">
                          <div className="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                          {(() => {
                            if (selectedUserType === 'agricopilot') return `${copilots.length} Total`;
                            if (selectedUserType === 'farmer') return `${farmers.length} Total`;
                            if (selectedUserType === 'landowner') return `${landowners.length} Total`;
                            if (selectedUserType === 'vendor') return `${vendors.length} Total`;
                            if (selectedUserType === 'buyer') return `${buyers.length} Total`;
                            if (selectedUserType === 'consumer') return `${consumers.length} Total`;
                            return '0 Total';
                          })()}
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Action Buttons */}
                  <div className="flex flex-wrap items-center gap-3">
                    {/* View Toggle Buttons */}
                    <div className="flex bg-gray-100 rounded-lg p-1">
                      <button
                        onClick={() => {
                          setShowOnboarding(true);
                          // Data will be fetched by the onboarding useEffect based on selectedUserType
                        }}
                        className={`px-4 py-2 rounded-md text-sm font-medium transition-all duration-200 flex items-center ${
                          showOnboarding 
                            ? 'bg-white text-blue-600 shadow-sm' 
                            : 'text-gray-600 hover:text-gray-800'
                        }`}
                      >
                        <List className="w-4 h-4 mr-2" />
                        View Registry
                      </button>
                    
                    </div>

                    {/* Action Buttons */}
                    <div className="flex items-center gap-3">
                      {/* Refresh Data Button */}
                      {showOnboarding && (
                        <button
                          onClick={() => {
                            switch (selectedUserType) {
                              case 'farmer':
                                fetchFarmers();
                                break;
                              case 'vendor':
                                fetchVendors();
                                break;
                              case 'buyer':
                                fetchBuyers();
                                break;
                              case 'landowner':
                                fetchLandowners();
                                break;
                              default:
                                fetchCopilots();
                            }
                          }}
                          disabled={loading}
                          className="px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hover:from-gray-600 hover:to-gray-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium transition-all duration-200 flex items-center shadow-md hover:shadow-lg"
                        >
                          {loading ? (
                            <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"></div>
                          ) : (
                            <Search className="w-4 h-4 mr-2" />
                          )}
                          {loading ? 'Loading...' : 'Refresh Data'}
                        </button>
                      )}
                    </div>

                    <input
                      type="file"
                      ref={fileInputRef}
                      onChange={handleFileUpload}
                      className="hidden"
                      multiple={true}
                      accept=".csv,.xlsx,.xls"
                    />
                  </div>
                </div>
              </div>

                  {/* Sub-navigation for Registry View */}
              {showOnboarding && (
                <div className="bg-white px-8 py-4 border-b border-gray-100">
                  <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="flex items-center space-x-4">
                      <h3 className="text-lg font-semibold text-gray-700">
                        {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)} Registry Overview
                      </h3>
                      <div className="flex items-center space-x-2">
                        <span className="text-sm text-gray-500">Last updated:</span>
                        <span className="text-sm font-medium text-gray-700">
                          {new Date().toLocaleTimeString()}
                        </span>
                      </div>
                    </div>
                    <div className="flex items-center space-x-3">
                      <span className="text-sm text-gray-500">Quick Actions:</span>
                      
                      {/* Download Dropdown */}
                      <div className="relative">
                        <button
                          onClick={() => setShowDownloadMenu(!showDownloadMenu)}
                          className="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:from-green-700 hover:to-emerald-700 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg"
                        >
                          <Download className="w-4 h-4 mr-2" />
                          Download
                          <ChevronDown className={`w-4 h-4 ml-2 transition-transform duration-200 ${showDownloadMenu ? 'rotate-180' : ''}`} />
                        </button>
                        
                        {/* Dropdown Menu */}
                        {showDownloadMenu && (
                          <>
                            {/* Backdrop to close dropdown */}
                            <div 
                              className="fixed inset-0 z-10" 
                              onClick={() => setShowDownloadMenu(false)}
                            ></div>
                            
                            {/* Dropdown content */}
                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 z-20 overflow-hidden">
                              <div className="py-1">
                                <button
                                  onClick={handleDownloadExcel}
                                  className="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 transition-colors"
                                >
                                  <FileText className="w-4 h-4 mr-3 text-green-600" />
                                  <span className="font-medium">Excel Format</span>
                                </button>
                                <div className="border-t border-gray-100"></div>
                                <button
                                  onClick={handleDownloadPDF}
                                  className="w-full flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700 transition-colors"
                                >
                                  <FileText className="w-4 h-4 mr-3 text-red-600" />
                                  <span className="font-medium">PDF Format</span>
                                </button>
                              </div>
                            </div>
                          </>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}            {showOnboarding ? (
              <div className="p-6">


                  {loading ? (
                    <div className="flex justify-center items-center py-8">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                      <span className="ml-2 text-gray-600">Loading AgriCopilots...</span>
                    </div>
                  ) : error ? (
                    <div className="text-center py-8 text-red-600 bg-red-50 rounded-lg">
                      <div className="mb-2">‚ö†Ô∏è Error loading data</div>
                      <div className="text-sm">{error}</div>
                      <button 
                        onClick={fetchCopilots} 
                        className="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm"
                      >
                        Retry
                      </button>
                    </div>
                  ) : (
                    <>

                      
                      {(selectedUserType === 'agricopilot' ? copilots.length === 0 : getUserStats(selectedUserType).total === 0) ? (
                        <div className="text-center py-8 text-gray-500">
                          <Users className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                          <div className="text-lg font-medium">
                            No {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)}s found
                            {selectedUserType === 'agricopilot' && ` (Debug: ${copilots.length} items, Loading: ${loading ? 'Yes' : 'No'})`}
                          </div>
                          <div className="text-sm mt-1">
                            {selectedUserType === 'agricopilot' ? 'Start by adding your first AgriCopilot employee' :
                             selectedUserType === 'farmer' ? 'Start by registering your first farmer' :
                             selectedUserType === 'landowner' ? 'Start by adding your first landowner' :
                             selectedUserType === 'vendor' ? 'Start by registering your first vendor' :
                             'Start by adding your first buyer'}
                          </div>
                          <button 
                            onClick={() => {
                              switch (selectedUserType) {
                                case 'farmer':
                                  fetchFarmers();
                                  break;
                                case 'vendor':
                                  fetchVendors();
                                  break;
                                case 'buyer':
                                  fetchBuyers();
                                  break;
                                case 'landowner':
                                  fetchLandowners();
                                  break;
                                default:
                                  fetchCopilots();
                              }
                            }}
                            className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                          >
                            Load Data
                          </button>
                        </div>
                      ) : (
                    <div className="overflow-hidden shadow ring-1 ring-black ring-opacity-5 rounded-lg">
                      <table className="min-w-full divide-y divide-gray-300">
                        <thead className="bg-gray-50">
                          <tr>
                            <th scope="col" className="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">
                              Name
                            </th>
                            <th scope="col" className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                              Email
                            </th>
                            <th scope="col" className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                              Location
                            </th>
                            <th scope="col" className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                              {selectedUserType === 'landowner' ? 'Property Location' :
                               selectedUserType === 'vendor' ? 'Business Type' :
                               selectedUserType === 'buyer' ? 'Purchase Category' :
                               selectedUserType === 'farmer' ? 'Farm Type' :
                               'Date'}
                            </th>
                            <th scope="col" className="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">
                              Status
                            </th>
                            <th scope="col" className="relative py-3.5 pl-3 pr-4 sm:pr-6">
                              <span className="sr-only">Actions</span>
                            </th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200 bg-white">
                          {(() => {
                            // Choose dataset based on selectedUserType
                            let items: any[] = [];
                            if (selectedUserType === 'farmer') items = farmers;
                            else if (selectedUserType === 'vendor') items = vendors;
                            else if (selectedUserType === 'buyer') items = buyers;
                            else if (selectedUserType === 'landowner') items = landowners;
                            else items = copilots;

                            if (!items || items.length === 0) {
                              return (
                                <tr>
                                  <td colSpan={6} className="text-center py-8 text-gray-500">
                                    No records found for {selectedUserType}
                                  </td>
                                </tr>
                              );
                            }

                            return items.map((it) => {
                              // Normalize fields
                              const id = it.id || it.user_id || it.userId;
                              const name = it.full_name || it.name || it.fullName || it.username;
                              const email = it.email || it.user_email || '';
                              const date = it.created_at || it.date || it.registration_date || null;
                              const status = it.verification_status || it.status || 'pending';

                              return (
                                <tr key={id} className="hover:bg-gray-50">
                                  <td className="whitespace-nowrap py-4 pl-4 pr-3 sm:pl-6">
                                    <div className="flex items-center">
                                      {it.photo_url ? (
                                        <img src={`${API_BASE_URL.replace('/admin','')}${it.photo_url}`} alt="" className="h-10 w-10 rounded-full object-cover" />
                                      ) : (
                                        <div className="h-10 w-10 rounded-full bg-gray-100 flex items-center justify-center">
                                          <User className="h-6 w-6 text-gray-400" />
                                        </div>
                                      )}
                                      <div className="ml-4">
                                        <div className="font-medium text-gray-900">{name}</div>
                                        <div className="text-gray-500 text-sm">{it.custom_id || it.customId || ''}</div>
                                      </div>
                                    </div>
                                  </td>
                                  <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{email}</td>
                                  <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                                    {it.location || `${it.city || 'N/A'}, ${it.state || 'N/A'}`}
                                  </td>
                                  <td className="whitespace-nowrap px-3 py-4 text-sm text-gray-500">{date ? new Date(date).toLocaleDateString() : '-'}</td>
                                  <td className="whitespace-nowrap px-3 py-4 text-sm">
                                    <span className={`inline-flex rounded-full px-2 text-xs font-semibold leading-5 ${status === 'approved' || status === 'verified' ? 'bg-green-100 text-green-800' : status === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                      {String(status).charAt(0).toUpperCase() + String(status).slice(1)}
                                    </span>
                                  </td>
                                  <td className="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                                    <button 
                                      onClick={() => {
                                        if (selectedUserType === 'agricopilot') {
                                          handleViewCopilotDetails(it);
                                        } else {
                                          handleViewUserDetails(it);
                                        }
                                      }} 
                                      className="text-blue-600 hover:text-blue-900 inline-flex items-center"
                                    >
                                      View<ChevronRight className="ml-1 h-4 w-4" />
                                    </button>
                                  </td>
                                </tr>
                              );
                            });
                          })()}
                        </tbody>
                      </table>
                    </div>
                      )}
                    </>
                  )}
                </div>
            ) : (
              <div className="bg-white shadow-lg rounded-lg p-6">
                <form onSubmit={handleSubmit} className="space-y-6">
                  <div className="grid grid-cols-2 gap-6">
                    <div>
                      <label htmlFor="fullName" className="block text-sm font-medium text-gray-700">
                        Full Name
                      </label>
                      <input
                        type="text"
                        id="fullName"
                        name="fullName"
                        className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm"
                        value={formData.fullName}
                        onChange={handleInputChange}
                      />
                    </div>
                  </div>
                  <div className="flex justify-end space-x-3">
                    <button
                      type="button"
                      onClick={() => setActiveTab('dashboard')}
                      className="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      disabled={formSubmitting}
                      className={`px-4 py-2 text-white rounded-md text-sm font-medium transition-colors ${
                        formSubmitting 
                          ? 'bg-gray-400 cursor-not-allowed' 
                          : 'bg-green-600 hover:bg-green-700'
                      }`}
                    >
                      {formSubmitting ? 'Sending Invitation...' : 'Send Invitation'}
                    </button>
                  </div>
                </form>
              </div>
            )}
            </div>
          </div>
        )}

        {activeTab === 'dashboard' && (
          <div className="p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">Dashboard Overview</h2>
            
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
              {userTypes.map((type) => {
                // Calculate real-time stats from actual data arrays
                let userList: any[] = [];
                if (type.id === 'agricopilot') userList = copilots;
                else if (type.id === 'farmer') userList = farmers;
                else if (type.id === 'landowner') userList = landowners;
                else if (type.id === 'vendor') userList = vendors;
                else if (type.id === 'buyer') userList = buyers;
                else if (type.id === 'consumer') userList = consumers;
                
                const totalCount = userList.length;
                const verifiedCount = userList.filter(u => u.verification_status === 'approved').length;
                const pendingCount = userList.filter(u => u.verification_status === 'pending').length;
                
                return (
                  <div 
                    key={type.id}
                    onClick={() => {
                          // Select user type and open AddEmployee tab, but do not open the add form automatically.
                          setSelectedUserType(type.id);
                          setActiveTab('addEmployee');
                          setShowEmployeeForm(false);
                          
                          // Fetch data for the selected user type if not already loaded
                          if (type.id === 'agricopilot' && copilots.length === 0) {
                            fetchCopilots();
                          } else if (type.id === 'farmer' && farmers.length === 0) {
                            fetchFarmers();
                          } else if (type.id === 'landowner' && landowners.length === 0) {
                            fetchLandowners();
                          } else if (type.id === 'vendor' && vendors.length === 0) {
                            fetchVendors();
                          } else if (type.id === 'buyer' && buyers.length === 0) {
                            fetchBuyers();
                          } else if (type.id === 'consumer' && consumers.length === 0) {
                            fetchConsumers();
                          }
                        }}
                    className="bg-white rounded-lg shadow-md overflow-hidden cursor-pointer hover:shadow-xl transition-all duration-300 group"
                  >
                    <div className="flex h-full">
                      {/* Left side - Clean Perfect Image */}
                      <div className="relative w-2/5 flex-shrink-0 overflow-hidden">
                        <div 
                          className="absolute inset-0 bg-cover bg-center"
                          style={{ backgroundImage: `url(${type.bgImage})` }}
                        >
                        </div>
                      </div>
                      
                      {/* Right side - Content */}
                      <div className="flex-1 p-4 flex flex-col justify-between bg-gradient-to-br from-white to-gray-50">
                        {/* Top section - Total count */}
                        <div>
                          <p className="text-xs text-gray-500 font-medium uppercase tracking-wide mb-1">
                            Total {type.label}s
                          </p>
                          <p className="text-3xl font-bold text-gray-800 mb-3">{totalCount}</p>
                        </div>
                        
                        {/* Bottom section - Stats */}
                        <div className="space-y-2">
                          <div className="flex items-center justify-between bg-green-50 px-3 py-2 rounded-md">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                              <span className="text-sm text-gray-700 font-medium">Verified</span>
                            </div>
                            <span className="text-sm font-bold text-green-700">{verifiedCount}</span>
                          </div>
                          <div className="flex items-center justify-between bg-yellow-50 px-3 py-2 rounded-md">
                            <div className="flex items-center space-x-2">
                              <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>
                              <span className="text-sm text-gray-700 font-medium">Pending</span>
                            </div>
                            <span className="text-sm font-bold text-yellow-700">{pendingCount}</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
            
            {/* Recent Activities */}
            <div className="bg-white rounded-lg shadow p-6">
              <div className="flex items-center justify-between mb-6">
                <h3 className="text-lg font-semibold text-gray-800">Recent Activities</h3>
                <button className="text-sm text-green-600 hover:text-green-700">View All</button>
              </div>
              <div className="space-y-4">
                {[1, 2, 3].map((item) => (
                  <div key={item} className="flex items-start pb-4 border-b border-gray-100 last:border-0 last:pb-0">
                    <div className="p-2 bg-green-50 rounded-full mr-4">
                      <Activity className="w-5 h-5 text-green-600" />
                    </div>
                    <div className="flex-1">
                      <p className="text-sm text-gray-800">New {userTypes[item % 3].label} registered</p>
                      <p className="text-xs text-gray-500 mt-1">{item} hour ago</p>
                    </div>
                    <button className="text-xs text-gray-400 hover:text-gray-600">
                      <MoreHorizontal className="w-4 h-4" />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}




          {/* User Details Modal */}
          {selectedUser && (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl shadow-2xl max-w-full w-full max-h-[90vh] overflow-y-auto">
                <div className="px-6 py-4 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className="h-12 w-12 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center text-white font-bold text-lg">
                        {selectedUser.name.charAt(0).toUpperCase()}
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">User Registration Details</h3>
                        <p className="text-sm text-gray-600 capitalize">{selectedUser.type}</p>
                      </div>
                    </div>
                    <button
                      onClick={handleCloseDetails}
                      className="text-gray-400 hover:text-gray-500 transition-colors"
                    >
                      <X className="h-6 w-6" />
                    </button>
                  </div>
                </div>
                <div className="px-6 py-6">
                  <div className="mb-6">
                    <h4 className="text-lg font-semibold text-gray-900 mb-4">Registration Information</h4>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <User className="h-4 w-4 mr-2" />
                        Full Name
                      </h4>
                      <p className="text-sm text-gray-900 font-medium">{selectedUser.name}</p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Mail className="h-4 w-4 mr-2" />
                        Email Address
                      </h4>
                      <p className="text-sm text-gray-900">{selectedUser.email}</p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Phone className="h-4 w-4 mr-2" />
                        Phone Number
                      </h4>
                      <p className="text-sm text-gray-900">{selectedUser.phone}</p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <MapPin className="h-4 w-4 mr-2" />
                        Location
                      </h4>
                      <p className="text-sm text-gray-900">{selectedUser.location}</p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Calendar className="h-4 w-4 mr-2" />
                        Registration Date
                      </h4>
                      <p className="text-sm text-gray-900">
                        {new Date(selectedUser.date).toLocaleDateString('en-US', {
                          year: 'numeric',
                          month: 'long',
                          day: 'numeric'
                        })}
                      </p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Users className="h-4 w-4 mr-2" />
                        User Type
                      </h4>
                      <p className="text-sm text-gray-900 capitalize font-medium">{selectedUser.type}</p>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Star className="h-4 w-4 mr-2" />
                        Verification Status
                      </h4>
                      <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                        selectedUser.status === 'verified' 
                          ? 'bg-green-100 text-green-800 border border-green-200' 
                          : 'bg-yellow-100 text-yellow-800 border border-yellow-200'
                      }`}>
                        {selectedUser.status === 'verified' ? (
                          <>
                            <UserCheck className="h-3 w-3 mr-1" />
                            Verified
                          </>
                        ) : (
                          <>
                            <Clock className="h-3 w-3 mr-1" />
                            Pending Verification
                          </>
                        )}
                      </span>
                    </div>
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border border-blue-100">
                      <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                        <Star className="h-4 w-4 mr-2" />
                        Availability Status
                      </h4>
                      <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                        selectedUser.availability === 'available' 
                          ? 'bg-green-100 text-green-800 border border-green-200' 
                          : 'bg-red-100 text-red-800 border border-red-200'
                      }`}>
                        {selectedUser.availability === 'available' ? (
                          <>
                            <UserCheck className="h-3 w-3 mr-1" />
                            Available
                          </>
                        ) : (
                          <>
                            <X className="h-3 w-3 mr-1" />
                            Unavailable
                          </>
                        )}
                      </span>
                    </div>
                  </div>
                  
                  {/* Additional Registration Fields */}
                  <div className="mt-6">
                    <h4 className="text-lg font-semibold text-gray-900 mb-4">Additional Information</h4>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                          <MapPin className="h-4 w-4 mr-2" />
                          State
                        </h4>
                        <p className="text-sm text-gray-900">{selectedUser.state || 'Not specified'}</p>
                      </div>
                      <div className="bg-gradient-to-r from-gray-50 to-blue-50 p-4 rounded-lg border border-gray-200">
                        <h4 className="text-sm font-medium text-gray-500 mb-2 flex items-center">
                          <MapPin className="h-4 w-4 mr-2" />
                          District
                        </h4>
                        <p className="text-sm text-gray-900">{selectedUser.district || 'Not specified'}</p>
                      </div>
                    </div>
                  </div>
                </div>
                <div className="px-6 py-4 bg-gray-50 flex justify-end space-x-3 rounded-b-xl">
                  <button
                    type="button"
                    className="px-6 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"
                    onClick={handleCloseDetails}
                  >
                    Close
                  </button>
                  <button
                    type="button"
                    className="px-6 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors flex items-center"
                    onClick={() => handleSendVerificationEmail(selectedUser)}
                  >
                    <Mail className="h-4 w-4 mr-2" />
                    Send Mail
                  </button>
                  {selectedUser.status === 'pending' && (
                    <button
                      type="button"
                      className="px-6 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors flex items-center"
                      onClick={() => {
                        handleVerifyUser(selectedUser.id);
                        handleCloseDetails();
                      }}
                    >
                      <UserCheck className="h-4 w-4 mr-2" />
                      Verify User
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
      {activeTab === 'addEmployee' && selectedUserType && (
        <div className="p-6">
          {/* User-specific Professional Header */}
          <div className="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl shadow-lg border border-gray-200 overflow-hidden mb-8">
            <div className="bg-white px-8 py-6">
              <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                {/* Enhanced Title Section */}
                <div className="flex items-center space-x-4">
                  <div className={`p-4 rounded-xl shadow-md ${
                    selectedUserType === 'agricopilot' ? 'bg-gradient-to-r from-green-500 to-blue-600' :
                    selectedUserType === 'farmer' ? 'bg-gradient-to-r from-green-500 to-emerald-600' :
                    selectedUserType === 'landowner' ? 'bg-gradient-to-r from-yellow-500 to-amber-600' :
                    selectedUserType === 'vendor' ? 'bg-gradient-to-r from-purple-500 to-indigo-600' :
                    'bg-gradient-to-r from-blue-500 to-cyan-600'
                  }`}>
                    <Users className="h-10 w-10 text-white" />
                  </div>
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900 mb-1">
                      {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)} Management
                    </h1>
                    <p className="text-gray-600 text-lg mb-3">
                      {selectedUserType === 'agricopilot' ? 'Manage agricultural consultants and experts' :
                       selectedUserType === 'farmer' ? 'Manage farmer registrations and activities' :
                       selectedUserType === 'landowner' ? 'Manage landowner properties and listings' :
                       selectedUserType === 'vendor' ? 'Manage agricultural supply vendors' :
                       'Manage agricultural product buyers'}
                    </p>
                    {/* Status indicators */}
                    <div className="flex items-center space-x-6 text-sm">
                      <div className="flex items-center">
                        <div className="w-3 h-3 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                        <span className="text-gray-600 font-medium">System Active</span>
                      </div>
                      <div className="flex items-center">
                        <Clock className="w-4 h-4 text-gray-500 mr-2" />
                        <span className="text-gray-500">
                          {new Date().toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                          })}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Enhanced Action Buttons */}
                <div className="flex flex-wrap items-center gap-3">
                  {selectedUserType && ['agricopilot', 'farmer', 'landowner', 'vendor', 'buyer', 'consumer'].includes(selectedUserType) && (
                    <>
                      <button
                        onClick={() => setShowEmployeeForm(true)}
                        className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl text-sm font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                      >
                        <UserPlus className="w-5 h-5 mr-2" />
                        {`Add ${selectedUserType === 'agricopilot' ? 'Employee' : selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)}`}
                      </button>

                      {/* Onboarding button for all user types */}
                      <button
                        onClick={() => {
                          setActiveTab('onboard');
                          setShowOnboarding(true);
                          if (!selectedUserType) return;
                          if (selectedUserType === 'agricopilot' && copilots.length === 0) {
                            fetchCopilots();
                          } else if (selectedUserType === 'farmer' && farmers.length === 0) {
                            fetchFarmers();
                          } else if (selectedUserType === 'vendor' && vendors.length === 0) {
                            fetchVendors();
                          } else if (selectedUserType === 'buyer' && buyers.length === 0) {
                            fetchBuyers();
                          } else if (selectedUserType === 'landowner' && landowners.length === 0) {
                            fetchLandowners();
                          } else if (selectedUserType === 'consumer' && consumers.length === 0) {
                            fetchConsumers();
                          }
                        }}
                        className="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl text-sm font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
                      >
                        <List className="w-5 h-5 mr-2" />
                        Onboarding
                      </button>
                    </>
                  )}
                </div>
              </div>
              
              {/* Quick Stats Bar */}
              <div className="mt-6 pt-6 border-t border-gray-100">
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {(() => {
                        if (selectedUserType === 'agricopilot') return copilots.filter(c => c.verification_status === 'approved').length;
                        if (selectedUserType === 'farmer') return farmers.filter(f => f.verification_status === 'approved').length;
                        if (selectedUserType === 'landowner') return landowners.filter(l => l.verification_status === 'approved').length;
                        if (selectedUserType === 'vendor') return vendors.filter(v => v.verification_status === 'approved').length;
                        if (selectedUserType === 'buyer') return buyers.filter(b => b.verification_status === 'approved').length;
                        if (selectedUserType === 'consumer') return consumers.filter(c => c.verification_status === 'approved').length;
                        return '0';
                      })()}
                    </div>
                    <div className="text-sm text-gray-500">Verified</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-yellow-600">
                      {(() => {
                        if (selectedUserType === 'agricopilot') return copilots.filter(c => c.verification_status === 'pending').length;
                        if (selectedUserType === 'farmer') return farmers.filter(f => f.verification_status === 'pending').length;
                        if (selectedUserType === 'landowner') return landowners.filter(l => l.verification_status === 'pending').length;
                        if (selectedUserType === 'vendor') return vendors.filter(v => v.verification_status === 'pending').length;
                        if (selectedUserType === 'buyer') return buyers.filter(b => b.verification_status === 'pending').length;
                        if (selectedUserType === 'consumer') return consumers.filter(c => c.verification_status === 'pending').length;
                        return '0';
                      })()}
                    </div>
                    <div className="text-sm text-gray-500">Pending</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {(() => {
                        if (selectedUserType === 'agricopilot') return copilots.length;
                        if (selectedUserType === 'farmer') return farmers.length;
                        if (selectedUserType === 'landowner') return landowners.length;
                        if (selectedUserType === 'vendor') return vendors.length;
                        if (selectedUserType === 'buyer') return buyers.length;
                        if (selectedUserType === 'consumer') return consumers.length;
                        return '0';
                      })()}
                    </div>
                    <div className="text-sm text-gray-500">Total</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {(() => {
                        // Get current month and year
                        const currentDate = new Date();
                        const currentMonth = currentDate.getMonth();
                        const currentYear = currentDate.getFullYear();
                        
                        // Get the appropriate user list
                        let userList: any[] = [];
                        if (selectedUserType === 'agricopilot') userList = copilots;
                        else if (selectedUserType === 'farmer') userList = farmers;
                        else if (selectedUserType === 'landowner') userList = landowners;
                        else if (selectedUserType === 'vendor') userList = vendors;
                        else if (selectedUserType === 'buyer') userList = buyers;
                        else if (selectedUserType === 'consumer') userList = consumers;
                        
                        // Filter users created this month
                        const thisMonthUsers = userList.filter(user => {
                          if (!user.created_at) return false;
                          const createdDate = new Date(user.created_at);
                          return createdDate.getMonth() === currentMonth && 
                                 createdDate.getFullYear() === currentYear;
                        });
                        
                        return thisMonthUsers.length;
                      })()}
                    </div>
                    <div className="text-sm text-gray-500">This Month</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* User Type Overview Table - Shows only approved users of selected type */}
          <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-8">
            <div className="px-6 py-4 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200">
              <h3 className="text-lg font-semibold text-gray-800">
                {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)} Overview
              </h3>
              <p className="text-sm text-gray-600 mt-1">View all approved {selectedUserType}s</p>
            </div>
            
            {/* Enhanced Filter Section */}
            <div className="p-6 bg-gray-50 border-b border-gray-200">
              <div className="flex items-center justify-between">
                <div className="flex-1 max-w-md">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Search</label>
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                    <input
                      type="text"
                      placeholder="Search users..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                    />
                  </div>
                </div>
                
                <div className="flex items-center space-x-4">
                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Filters</label>
                    <div className="flex items-center space-x-2">
                      <button className="p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                        <Settings className="h-5 w-5" />
                      </button>
                      <div className="flex items-center space-x-2">
                        <select
                          value={selectedState}
                          onChange={(e) => setSelectedState(e.target.value)}
                          className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm"
                        >
                          <option value="all">All States</option>
                          {indianStates.map((state) => (
                            <option key={state} value={state}>{state}</option>
                          ))}
                        </select>
                        
                        <select
                          value={selectedDistrict}
                          onChange={(e) => setSelectedDistrict(e.target.value)}
                          className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors text-sm"
                          disabled={selectedState === 'all'}
                        >
                          <option value="all">All Districts</option>
                          {availableDistricts.map((district) => (
                            <option key={district} value={district}>{district}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Enhanced Table */}
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                  <tr>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      <div className="flex items-center space-x-2">
                        <User className="h-4 w-4" />
                        <span>Name</span>
                      </div>
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      <div className="flex items-center space-x-2">
                        <Mail className="h-4 w-4" />
                        <span>Email</span>
                      </div>
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      <div className="flex items-center space-x-2">
                        <Phone className="h-4 w-4" />
                        <span>Phone</span>
                      </div>
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      <div className="flex items-center space-x-2">
                        <MapPin className="h-4 w-4" />
                        <span>Location</span>
                      </div>
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      <div className="flex items-center space-x-2">
                        <Star className="h-4 w-4" />
                        <span>Status</span>
                      </div>
                    </th>
                    <th className="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {(() => {
                    // Get the appropriate user list based on selected user type
                    let userList: any[] = [];
                    if (selectedUserType === 'agricopilot') {
                      userList = copilots;
                    } else if (selectedUserType === 'farmer') {
                      userList = farmers;
                    } else if (selectedUserType === 'landowner') {
                      userList = landowners;
                    } else if (selectedUserType === 'vendor') {
                      userList = vendors;
                    } else if (selectedUserType === 'buyer') {
                      userList = buyers;
                    } else if (selectedUserType === 'consumer') {
                      userList = consumers;
                    }

                    // Filter: only approved users
                    userList = userList.filter(user => user.verification_status === 'approved');

                    // Apply search filter
                    if (searchTerm) {
                      userList = userList.filter(user => 
                        user.full_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        user.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        user.phone?.includes(searchTerm)
                      );
                    }

                    // Apply state filter
                    if (selectedState && selectedState !== 'all') {
                      userList = userList.filter(user => user.state === selectedState || (user.location && user.location.includes(selectedState)));
                    }

                    // Apply district filter
                    if (selectedDistrict && selectedDistrict !== 'all') {
                      userList = userList.filter(user => user.district === selectedDistrict || (user.location && user.location.includes(selectedDistrict)));
                    }

                    return userList.length > 0 ? userList.map((user, index) => (
                      <tr key={user.custom_id || index} className={`hover:bg-gradient-to-r hover:from-green-50 hover:to-blue-50 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}`}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            <div className="flex-shrink-0 h-12 w-12">
                              {user.photo_url ? (
                                <img 
                                  src={`${API_BASE_URL.replace('/admin','')}${user.photo_url}`}
                                  alt={user.full_name}
                                  className="h-12 w-12 rounded-full object-cover"
                                  onError={(e) => {
                                    e.currentTarget.style.display = 'none';
                                  }}
                                />
                              ) : (
                                <div className="h-12 w-12 rounded-full bg-gradient-to-r from-green-400 to-blue-500 flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                  {user.full_name?.charAt(0).toUpperCase()}
                                </div>
                              )}
                            </div>
                            <div className="ml-4">
                              <div className="text-sm font-semibold text-gray-900">{user.full_name}</div>
                              <div className="text-xs text-gray-500">{user.custom_id}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-gray-900">{user.email}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-gray-900">{user.phone}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="text-sm text-gray-900">{user.location || 'N/A'}</div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                            <UserCheck className="h-3 w-3 mr-1" />
                            Approved
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <button
                            onClick={() => {
                              setSelectedCopilot(user);
                              setShowCopilotDetails(true);
                            }}
                            className="text-green-600 hover:text-green-900 mr-4"
                          >
                            View Details
                          </button>
                        </td>
                      </tr>
                    )) : (
                      <tr>
                        <td colSpan={6} className="px-6 py-12 text-center">
                          <div className="flex flex-col items-center justify-center text-gray-500">
                            <Users className="h-12 w-12 mb-4 text-gray-300" />
                            <p className="text-lg font-medium">No approved {selectedUserType}s found</p>
                            <p className="text-sm mt-1">Try adjusting your search or filters</p>
                          </div>
                        </td>
                      </tr>
                    );
                  })()}
                </tbody>
              </table>
            </div>
          </div>

          {/* Add Employee Form Modal */}
          {showEmployeeForm && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4"
              onClick={() => setShowEmployeeForm(false)}
            >
              <div 
                className="relative bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col animate-in zoom-in-95 duration-300"
                onClick={(e) => e.stopPropagation()}
              >
                {/* Modal Header - Sticky */}
                <div className="sticky top-0 z-10 px-8 py-6 bg-gradient-to-r from-green-50 to-blue-50 border-b border-gray-200 rounded-t-2xl">
                  <div className="flex justify-between items-start">
                    <div>
                      <h2 className="text-3xl font-bold text-gray-900 mb-2">Add New {selectedUserType.charAt(0).toUpperCase() + selectedUserType.slice(1)}</h2>
                      <p className="text-gray-600">Choose how you want to add users</p>
                    </div>
                    <button
                      onClick={() => setShowEmployeeForm(false)}
                      className="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-white rounded-lg"
                      aria-label="Close modal"
                    >
                      <X className="w-6 h-6" />
                    </button>
                  </div>
                  
                  {/* Toggle between Single and Bulk */}
                  <div className="flex bg-gray-100 rounded-lg p-1 max-w-md mt-4">
                    <button
                      onClick={() => setUploadType('single')}
                      className={`flex-1 py-3 px-6 text-sm font-medium rounded-md transition-all duration-200 flex items-center justify-center ${
                        !uploadType || uploadType === 'single' 
                          ? 'bg-white text-green-600 shadow-sm' 
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      <User className="w-4 h-4 mr-2" />
                      Single Entry
                    </button>
                    <button
                      onClick={() => setUploadType('bulk')}
                      className={`flex-1 py-3 px-6 text-sm font-medium rounded-md transition-all duration-200 flex items-center justify-center ${
                        uploadType === 'bulk' 
                          ? 'bg-white text-blue-600 shadow-sm' 
                          : 'text-gray-600 hover:text-gray-800'
                      }`}
                    >
                      <Upload className="w-4 h-4 mr-2" />
                      Bulk Upload
                    </button>
                  </div>
                </div>

                {/* Modal Content - Scrollable */}
                <div className="flex-1 overflow-y-auto">
              {/* Single Entry Form */}
              {(!uploadType || uploadType === 'single') && (
                <div className="p-8">
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">Personal Details</h3>
                    <p className="text-gray-600">Fill in the details below to register a new employee</p>
                  </div>
                  
                  <form onSubmit={handleSubmit} className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                      <div>
                        <label htmlFor="fullName" className="block text-sm font-medium text-gray-700 mb-2">
                          <User className="inline h-4 w-4 mr-2" />
                          Full Name
                        </label>
                        <input
                          type="text"
                          id="fullName"
                          name="fullName"
                          value={formData.fullName}
                          onChange={handleInputChange}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-2 focus:ring-green-500 transition-colors"
                          placeholder="Enter full name"
                          required
                        />
                      </div>
                      <div>
                        <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                          <Mail className="inline h-4 w-4 mr-2" />
                          Email Address
                        </label>
                        <input
                          type="email"
                          id="email"
                          name="email"
                          value={formData.email}
                          onChange={handleInputChange}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-2 focus:ring-green-500 transition-colors"
                          placeholder="Enter email address"
                          required
                        />
                      </div>
                      <div>
                        <label htmlFor="phone" className="block text-sm font-medium text-gray-700 mb-2">
                          <Phone className="inline h-4 w-4 mr-2" />
                          Phone Number
                        </label>
                        <input
                          type="tel"
                          id="phone"
                          name="phone"
                          value={formData.phone}
                          onChange={handleInputChange}
                          className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:border-green-500 focus:ring-2 focus:ring-green-500 transition-colors"
                          placeholder="Enter phone number"
                          required
                        />
                      </div>
                    </div>
                    
                    <div className="flex justify-end space-x-4 pt-6">
                      <button
                        type="button"
                        onClick={() => setShowEmployeeForm(false)}
                        className="px-6 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                      >
                        Cancel
                      </button>
                      <button
                        type="submit"
                        disabled={formSubmitting}
                        className={`px-6 py-3 rounded-lg text-sm font-medium transition-colors flex items-center ${
                          formSubmitting 
                            ? 'bg-gray-400 cursor-not-allowed text-white' 
                            : 'bg-green-600 hover:bg-green-700 text-white'
                        }`}
                      >
                        <Mail className="h-4 w-4 mr-2" />
                        {formSubmitting ? 'Sending Invitation...' : 'Submit and Send Mail'}
                      </button>
                    </div>
                  </form>
                </div>
              )}

              {/* Bulk Upload Section */}
              {uploadType === 'bulk' && (
                <div className="p-8">
                  <div className="mb-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-2">Bulk Upload Users</h3>
                    <p className="text-gray-600">Upload multiple users using CSV or Excel files with member type classification</p>
                  </div>

                  {/* Upload Progress */}
                  {isUploading && (
                    <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-medium text-blue-700">Uploading...</span>
                        <span className="text-sm text-blue-600">{Math.round(uploadProgress)}%</span>
                      </div>
                      <div className="w-full bg-blue-200 rounded-full h-2">
                        <div 
                          className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                          style={{ width: `${uploadProgress}%` }}
                        ></div>
                      </div>
                    </div>
                  )}
                  
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-500 transition-colors">
                    <div className="space-y-4">
                      <div className="mx-auto w-16 h-16 bg-green-50 rounded-full flex items-center justify-center">
                        <Upload className="w-8 h-8 text-green-600" />
                      </div>
                      <div>
                        <h4 className="text-lg font-medium text-gray-900 mb-2">Upload User Data</h4>
                        <p className="text-gray-600 mb-4">Select one or more CSV or Excel files to upload</p>
                        <input
                          type="file"
                          ref={fileInputRef}
                          onChange={handleFileUpload}
                          className="hidden"
                          accept=".csv,.xlsx,.xls"
                          multiple
                          disabled={isUploading}
                        />
                        <button
                          onClick={() => fileInputRef.current?.click()}
                          disabled={isUploading}
                          className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center mx-auto disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          <Upload className="w-4 h-4 mr-2" />
                          {isUploading ? 'Uploading...' : 'Choose Files'}
                        </button>
                      </div>
                      <div className="text-sm text-gray-500">
                        Supported formats: CSV and Excel files (.csv, .xlsx, .xls). Multiple files allowed for bulk processing.
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    {/* CSV Format Requirements */}
                    <div className="p-4 bg-blue-50 rounded-lg">
                      <h5 className="font-medium text-blue-900 mb-2">Required CSV Columns:</h5>
                      <div className="text-sm text-blue-800 space-y-1">
                        <p>‚Ä¢ <strong>full_name</strong> - User's full name</p>
                        <p>‚Ä¢ <strong>email</strong> - User's email address</p>
                        <p>‚Ä¢ <strong>phone</strong> - User's phone number (will add +91 prefix)</p>
                        <p>‚Ä¢ <strong>member_type</strong> - farmer, landowner, vendor, buyer, consumer, agri_copilot</p>
                      </div>
                      <div className="mt-3">
                        <button
                          onClick={() => {
                            // Download sample CSV template with member types
                            const csvContent = "full_name,email,phone,member_type\nJohn Doe,john@example.com,9876543210,farmer\nJane Smith,jane@example.com,9876543211,landowner\nBob Johnson,bob@example.com,9876543212,vendor\nAlice Brown,alice@example.com,9876543213,buyer\nTom Wilson,tom@example.com,9876543214,consumer\nSara Davis,sara@example.com,9876543215,agri_copilot";
                            const blob = new Blob([csvContent], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'bulk_upload_template.csv';
                            a.click();
                            window.URL.revokeObjectURL(url);
                          }}
                          className="text-sm text-blue-600 hover:text-blue-800 underline"
                        >
                          üì• Download Sample Template
                        </button>
                      </div>
                    </div>

                    {/* Member Type Information */}
                    <div className="p-4 bg-green-50 rounded-lg">
                      <h5 className="font-medium text-green-900 mb-2">Supported Member Types:</h5>
                      <div className="text-sm text-green-800 space-y-1">
                        <p>‚Ä¢ <strong>farmer</strong> - Agricultural producers</p>
                        <p>‚Ä¢ <strong>landowner</strong> - Land proprietors</p>
                        <p>‚Ä¢ <strong>vendor</strong> - Service/product suppliers</p>
                        <p>‚Ä¢ <strong>buyer</strong> - Product purchasers</p>
                        <p>‚Ä¢ <strong>consumer</strong> - End users</p>
                        <p>‚Ä¢ <strong>agri_copilot</strong> - AI assistants</p>
                      </div>
                      <div className="mt-3 p-2 bg-yellow-100 rounded border-l-4 border-yellow-400">
                        <p className="text-xs text-yellow-800">
                          üí° <strong>Tip:</strong> Use lowercase for member_type values. Phone numbers will automatically get +91 prefix if not present.
                        </p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex justify-end space-x-4 pt-6">
                    <button
                      type="button"
                      onClick={() => setShowEmployeeForm(false)}
                      className="px-6 py-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
                </div>
              </div>
            </div>
          )}
        </div>
      )}
      </main>

      {/* AgriCopilot Details Modal */}
      <UserDetailsModal
        user={selectedCopilot}
        isOpen={showCopilotDetails && !!selectedCopilot}
        onClose={closeCopilotDetails}
        onSendVerificationEmail={() => {
          // Optional: Implement send verification email functionality
          console.log('Send verification email to', selectedCopilot?.email);
        }}
        onVerifyUser={() => {
          // Optional: Implement verify user functionality
          console.log('Verify user', selectedCopilot?.id);
        }}
      />

      {/* Enhanced User Details Modal (All User Types) */}
      <UserDetailsModal
        user={selectedDetailUser}
        isOpen={showUserDetails && !!selectedDetailUser}
        onClose={closeUserDetails}
        onSendVerificationEmail={(user) => {
          window.open(`mailto:${user.email || user.user_email}`, '_blank');
        }}
        onVerifyUser={(user) => {
          handleUpdateStatus(
            user.id || user.user_id || user.userId, 
            'approve', 
            selectedUserType || 'farmer'
          );
        }}
      />
    </div>
  );
};

// Wrapper component for Next.js page routing
const SuperAdminPage: React.FC = () => {
  return (
    <ProtectedRoute requiredRole="super_admin">
      <SuperAdmin />
    </ProtectedRoute>
  );
};

export default SuperAdminPage;
